{% extends "layout/app.html" %}

{% block title %}{{ product.name }} - Shopping Cart{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        {% if product.images %}
            <div id="productImageCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in product.images %}
                        <div class="carousel-item {% if image.is_primary or loop.first %}active{% endif %}">
                            <img src="{{ image.file_path }}" class="d-block w-100 rounded shadow" 
                                 style="height: 400px; object-fit: cover;" alt="{{ product.name }}">
                        </div>
                    {% endfor %}
                </div>
                {% if product.images|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#productImageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productImageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                {% endif %}
            </div>
        {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                <i class="fas fa-image fa-5x text-muted"></i>
            </div>
        {% endif %}
    </div>
    
    <div class="col-md-6">
        <h1>{{ product.name }}</h1>
        
        {% if product.category %}
            <span class="badge bg-secondary mb-3">{{ product.category.name }}</span>
        {% endif %}
        
        <div class="mb-3">
            <h3 class="text-primary">${{ "%.2f"|format(product.price) }}</h3>
        </div>
        
        <div class="mb-3">
            <strong>Stock:</strong> 
            <span class="{% if product.stock_quantity > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ product.stock_quantity }} {% if product.stock_quantity == 1 %}item{% else %}items{% endif %} available
            </span>
        </div>
        
        {% if product.description %}
            <div class="mb-4">
                <h5>Description</h5>
                <p>{{ product.description }}</p>
            </div>
        {% endif %}
        
        <div class="mb-4">
            <div class="row">
                <div class="col-md-4">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="quantity" value="1" min="1" max="{{ product.stock_quantity }}">
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-block">
            <button class="btn btn-primary btn-lg add-to-cart-btn" 
                    data-product-id="{{ product.id }}"
                    {% if product.stock_quantity <= 0 %}disabled{% endif %}>
                <i class="fas fa-cart-plus me-2"></i>
                {% if product.stock_quantity <= 0 %}Out of Stock{% else %}Add to Cart{% endif %}
            </button>
            
            <a href="{{ url_for('home.index') }}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Back to Products
            </a>
        </div>
    </div>
</div>

<!-- Related Products Section -->
<div class="row mt-5">
    <div class="col-12">
        <h3>Related Products</h3>
        <div class="row">
            <!-- This would typically show related products from the same category -->
            <div class="col-12">
                <p class="text-muted">Related products would be displayed here based on category.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Add to cart functionality
    $('.add-to-cart-btn').click(function() {
        const productId = $(this).data('product-id');
        const quantity = parseInt($('#quantity').val());
        const button = $(this);
        
        if (quantity < 1) {
            showAlert('Please enter a valid quantity', 'warning');
            return;
        }
        
        // Disable button during request
        button.prop('disabled', true);
        button.html('<i class="fas fa-spinner fa-spin me-2"></i>Adding...');
        
        $.ajax({
            url: '{{ url_for("home.add_to_cart") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                product_id: productId,
                quantity: quantity
            }),
            success: function(response) {
                if (response.success) {
                    // Update cart badge
                    $('#cart-badge').text(response.cart_summary.total_items);
                    
                    // Show success message
                    showAlert(`${quantity} item(s) added to cart!`, 'success');
                    
                    // Reset button
                    button.html('<i class="fas fa-check me-2"></i>Added!');
                    setTimeout(function() {
                        button.html('<i class="fas fa-cart-plus me-2"></i>Add to Cart');
                        button.prop('disabled', false);
                    }, 2000);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert(response.error || 'Error adding product to cart', 'danger');
                
                // Reset button
                button.html('<i class="fas fa-cart-plus me-2"></i>Add to Cart');
                button.prop('disabled', false);
            }
        });
    });
    
    // Load cart summary on page load
    loadCartSummary();
});

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.container').first().prepend(alertHtml);
    
    // Auto-dismiss after 3 seconds
    setTimeout(function() {
        $('.alert').alert('close');
    }, 3000);
}
</script>
{% endblock %}
